<!-- C:\Users\plamy\OneDrive\เดสก์ท็อป\Task_Project\views\admin\SettingAdmin_admin.ejs -->
<style>
    .secsettingadmin {
        width: 100%;
    }

    .headsecsettingadmin {
        background-color: #323450;
        color: #ffffff;
        padding: 22px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .headsecsettingadmin h2 {
        margin: 0;
    }

    .profilesection {
        width: 100%;
        display: flex;
    }

    .editimgprofile {
        display: flex;
        flex-direction: column;
        width: 46%;
        margin-right: 4%;
        align-items: center;
        background-color: #323450;
        color: #ffff;
        padding: 24px;
        border-radius: 10px;
        justify-content: center;
    }

    .editimgprofile img {
        height: 150px;
        width: 150px;
        border-radius: 100%;
        background-color: rgb(255, 255, 255);
        object-fit: cover;
        object-position: center;
        border: 15px solid #242647;
    }

    .editimgprofile button {
        width: auto;
        height: auto;
        padding: 22px;
        border: #ffffff solid 1px;
        background-color: #323450;
        color: #cccccc;
        border-radius: 10px;
    }

    .editimgprofile button:hover {
        background-color: #242647;
        color: #ffff;
    }

    .editimgprofile span {
        margin: 16px 0;
        font-size: 22px;
    }

    .aboutadminsection {
        width: 50%;
        display: block;
    }

    .aboutadmin {
        align-items: center;
        background-color: #323450;
        color: #ffff;
        padding: 24px;
        border-radius: 10px;
        height: fit-content;
    }

    .aboutadmin:first-child {
        margin-bottom: 10px;
    }

    .aboutadmin .row {
        display: flex;
        flex-wrap: wrap;
        margin: 20px 0;
    }


    .aboutadmin .row .col {
        width: 30%;
        font-size: 18px;
    }

    .aboutadmin .row .col1 {
        width: 70%;
        font-size: 18px;
    }

    .aboutadmin .email1 button {
        width: auto;
        height: auto;
        padding: 10px 20px;
        border: #ffffff solid 1px;
        background-color: #323450;
        color: #cccccc;
        border-radius: 10px;
    }

    .aboutadmin .email1 button:hover {
        background-color: #242647;
        color: #ffff;
    }


    .aboutadmin .col p {
        margin: 0;
        width: 100%;

    }

    .aboutadmin .col1 span {

        width: 100%;
        color: #ffffff;
        opacity: 0.9;
    }

    .aboutadmin hr {
        margin: 16px 0px;
        border: 0;
        border-top: 1px solid;
        opacity: 0.25;
    }

    .popup {
        display: none;
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        border: 1px solid #ccc;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
        background-color: white;
        padding: 20px;
        z-index: 100;
        border-radius: 10px;
    }

    .popup-table {
        width: 80%;
        max-width: 800px;
        margin: 20px auto;
    }

    .close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
    }

    /* สไตล์สำหรับ Popup */
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1001;
        color: #000000;
    }

    .popup-content {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 600px;
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
        z-index: 1002;
    }

    .popup-content .bx {
        font-size: 25px;
        color: #000000;
    }

    .popup-content .bx {
        font-size: 25px;
        color: #000000;
    }

    .popup-content input {
        padding: 10px;
        margin: 10px 0 20px 0;
        width: 90%;
    }

    .popup-header {
        font-size: 20px;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .popup-header button {
        background-color: transparent;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
    }

    .user-details {
        padding: 10px;
        border-bottom: 1px solid #ddd;
    }

    .user-details p {
        margin: 5px 0 20px 0;
    }

    .user-details .text {
        font-weight: bold;
        display: inline;
        width: 50px;
        margin-right: 20px;
    }

    .user-details input[type="text"] {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
    }

    .popup-actions {
        padding: 10px;
        display: flex;
        justify-content: flex-end;
    }

    .popup-actions button {
        margin-left: 10px;
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .user-details button {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .popup-actions i {
        color: #000;
    }

    .popup-actions .delete-btn {
        background-color: #ff4d4d;
        color: white;
    }

    .confirm-delete-btn {
        background-color: #ff4d4d;
        color: white;
    }

    .cancel-btn {
        background-color: #ccc;
        color: black;
    }


    @media (max-width: 768px) {
        .main-container {
            width: 100%;
            padding: 10px;
        }

        .profilesection {
            display: block;
            align-items: center;
        }

        .profilesection img {
            width: 100px;
            height: 100px;
        }

        .editimgprofile {
            margin: 20px 0;
            width: 50%;

        }

        .aboutadmin {
            width: 50%;
        }

        .aboutadmin .row {
            display: block;
        }

        .aboutadmin .row .col {
            width: 100%;
            font-size: 18px;
        }

        .aboutadmin .row .col1 {
            width: 100%;
            font-size: 16px;
        }

        .aboutadmin .col p {
            width: 100%;
            margin-block-start: 10px;
            margin-block-end: 10px;
        }

        .aboutadmin .col1 span {
            width: 100%;
            color: #ffffff;
            opacity: 0.8;
            margin-block-start: 10px;
            margin-block-end: 10px;
        }

    }
</style>
<div class="main-container">
    <div class="content">
        <div class="secsettingadmin">
            <div class="headsecsettingadmin">
                <h2>ตั้งค่าผู้ดูแลระบบ</h2>
            </div>

            <div class="profilesection">
                <form class="editimgprofile" action="/SettingAdmin/updateProfileImage" method="post"
                    enctype="multipart/form-data">
                    <div class="editimgprofile">
                        <img id="profileImageDisplay" src="<%= user.profileImage %>" alt="Profile Image"
                            onclick="document.getElementById('profileImageInput').click();">
                        <input type="file" name="profileImage" id="profileImageInput" style="display: none;">
                        <span>
                            <%= user.username %>
                        </span>
                        <button type="submit">เปลี่ยนรูปโปรไฟล์</button>
                    </div>
                </form>
                <!-- <div class="editimgprofile">
                    
                    <img src="<%= user.profileImage %>" alt="Profile Image">
                    <span>
                        <%= user.username %>
                    </span>
                    <button>เปลี่ยนรูปโปรไฟล์</button>
                </div> -->
                <div class="aboutadminsection">
                    <div class="aboutadmin">
                        <div class="row">
                            <div class="col username">
                                <p>ชื่อผู้ใช้</p>
                            </div>
                            <div class="col1 username1">
                                <span>
                                    <%= user.username %>
                                </span>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col email">
                                <p>อีเมล</p>
                            </div>
                            <div class="col1 email1">
                                <span>
                                    <%= user.googleEmail %>
                                </span>
                            </div>
                        </div>

                        <hr>
                        <div class="row">
                            <div class="col email">
                                <p>รหัสผ่าน</p>
                            </div>
                            <div class="col1 email1">
                                <span>
                                    <button onclick="openChangePasswordPopup()">เปลี่ยนรหัสผ่าน</button> </span>
                            </div>
                        </div>

                    </div>
                    <div class="aboutadmin">
                        <div class="row">
                            <div class="col">
                                <p>ประวัติการเข้าสู่ระบบ</p>
                            </div>
                            <div class="col1">
                                <span class="show-login-history" style="cursor: pointer; color: #ADD8E6;">
                                    คลิกเพื่อดูประวัติการเข้าสู่ระบบ
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="changePasswordPopup" class="popup-overlay">
    <div class="popup-content">
        <div class="popup-header">
            <span>เปลี่ยนรหัสผ่าน</span>
            <button onclick="closePopup('changePasswordPopup')"><i class='bx bx-x'></i></button>
        </div>
        <div class="user-details">
            <form id="changePasswordForm" action="/SettingAdmin/changePassword" method="post">
                <div>
                    <label for="currentPassword">รหัสผ่านปัจจุบัน:</label>
                    <input type="password" id="currentPassword" name="currentPassword" placeholder="รหัสผ่านปัจจุบัน"
                        required>
                    <i class="bx bx-show" id="currentPasswordToggle"
                        onclick="togglePasswordVisibility('currentPassword')"></i>
                </div>
                <div>
                    <label for="newPassword">รหัสผ่านใหม่:</label>
                    <input type="password" id="newPassword" name="newPassword" placeholder="รหัสผ่านปัจจุบัน" required>
                    <i class="bx bx-show" id="newPasswordToggle" onclick="togglePasswordVisibility('newPassword')"></i>
                </div>
                <div>
                    <label for="confirmPassword">ยืนยันรหัสผ่านใหม่:</label>
                    <input type="password" id="confirmPassword" name="confirmPassword"
                        placeholder="ยืนยันรหัสผ่านปัจจุบัน" required>
                    <i class="bx bx-show" id="confirmPasswordToggle"
                        onclick="togglePasswordVisibility('confirmPassword')"></i>
                </div>
            </form>
        </div>
        <div class="popup-actions">
            <button type="submit" form="changePasswordForm">ยืนยัน</button>
        </div>
    </div>
</div>

<div id="loginHistoryPopup" class="popup-overlay">
    <div class="popup-content">
        <div class="popup-header">
            <span>ประวัติการเข้าสู่ระบบ</span>
            <button onclick="closePopup('loginHistoryPopup')"><i class='bx bx-x'></i></button>
        </div>
        <div class="popup-body" id="loginHistoryContent">
            <!-- เนื้อหาจะถูกเพิ่มที่นี่ -->
        </div>
        <div class="popup-actions">
            <button onclick="closePopup('loginHistoryPopup')">ปิด</button>
        </div>
    </div>
</div>

<script>
    document.querySelector('.show-login-history').addEventListener('click', async () => {
    try {
        const response = await fetch('/SettingAdmin/loginHistory');
        const data = await response.json();

        if (data.success) {
            const { lastLogin, lastActive } = data.data;
            const loginHistoryContent = `
                <p><strong>เข้าสู่ระบบล่าสุด:</strong> ${new Date(lastLogin).toLocaleString()}</p>
                <p><strong>กิจกรรมล่าสุด:</strong> ${new Date(lastActive).toLocaleString()}</p>
            `;
            document.getElementById('loginHistoryContent').innerHTML = loginHistoryContent;
            document.getElementById('loginHistoryPopup').style.display = 'block';
        } else {
            alert(data.message);
        }
    } catch (error) {
        console.error('Error fetching login history:', error);
        alert('เกิดข้อผิดพลาดในการดึงข้อมูล');
    }
});
</script>

<script>

    function togglePasswordVisibility(inputId) {
        const passwordInput = document.getElementById(inputId);
        const passwordToggle = document.getElementById(inputId + 'Toggle');

        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            passwordToggle.classList.remove('bx-show');
            passwordToggle.classList.add('bx-hide');
        } else {
            passwordInput.type = 'password';
            passwordToggle.classList.remove('bx-hide');
            passwordToggle.classList.add('bx-show');
        }
    }
</script>

<script>
    

    function closePopup(popupId) {
        document.getElementById(popupId).style.display = "none";
    }

    function openChangePasswordPopup() {
        document.getElementById('changePasswordPopup').style.display = 'block';
    }

    // ฟังก์ชันสำหรับตรวจสอบรหัสผ่าน
    function validatePassword(password) {
        // ตรวจสอบความยาวอย่างน้อย 8 ตัวอักษร
        if (password.length < 8) {
            return "รหัสผ่านต้องมีความยาวอย่างน้อย 8 ตัวอักษร";
        }
        // ตรวจสอบว่ามีตัวอักษรพิมพ์ใหญ่ ตัวอักษรพิมพ์เล็ก และตัวเลข
        if (!/[A-Z]/.test(password) || !/[a-z]/.test(password) || !/[0-9]/.test(password)) {
            return "รหัสผ่านต้องมีตัวอักษรพิมพ์ใหญ่ ตัวอักษรพิมพ์เล็ก และตัวเลข";
        }
        return null; // ผ่านเงื่อนไขทั้งหมด
    }

    // ฟังก์ชันสำหรับแสดง/ซ่อนรหัสผ่าน
    function togglePasswordVisibility(inputId) {
        const passwordInput = document.getElementById(inputId);
        const passwordToggle = document.getElementById(inputId + 'Toggle');

        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            passwordToggle.classList.remove('bx-show');
            passwordToggle.classList.add('bx-hide');
        } else {
            passwordInput.type = 'password';
            passwordToggle.classList.remove('bx-hide');
            passwordToggle.classList.add('bx-show');
        }
    }

    //  เพิ่ม Event Listener สำหรับ submit form
    document.getElementById('changePasswordForm').addEventListener('submit', function (event) {
        event.preventDefault(); // ป้องกันการ submit form แบบปกติ

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // ตรวจสอบรหัสผ่านใหม่
        const newPasswordError = validatePassword(newPassword);
        if (newPasswordError) {
            alert(newPasswordError);
            return;
        }

        //  ตรวจสอบว่ารหัสผ่านใหม่ตรงกับการยืนยันหรือไม่
        if (newPassword !== confirmPassword) {
            alert('รหัสผ่านใหม่ไม่ตรงกับการยืนยัน');
            return;
        }

        //  ส่งข้อมูลไปยัง server ด้วย AJAX
        fetch('/SettingAdmin/changePassword', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ currentPassword, newPassword })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    closePopup('changePasswordPopup');
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('เกิดข้อผิดพลาดในการเปลี่ยนรหัสผ่าน');
            });
    });

    //  โค้ดสำหรับเปลี่ยนรูปโปรไฟล์
    const profileImageInput = document.getElementById('profileImageInput');
    const profileImageDisplay = document.getElementById('profileImageDisplay');

    profileImageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        const reader = new FileReader();

        reader.onload = (event) => {
            profileImageDisplay.src = event.target.result;
        }
        reader.readAsDataURL(file);
    });
</script>
//
<script>
    //     function closePopup(popupId) {
    //       document.getElementById(popupId).style.display = "none";
    //     }

    //     document.querySelector('.show-login-history').addEventListener('click', function() {
    //       document.getElementById('loginHistoryPopup').style.display = "block";
    //     });

    //     document.querySelector('.show-activity-log').addEventListener('click', function() {
    //       document.getElementById('activityLogPopup').style.display = "block";
    //     });
//   </script>